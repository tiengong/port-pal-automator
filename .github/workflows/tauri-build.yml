name: Tauri Build for Windows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ï¼ˆåŒ…å«å®Œæ•´å†å²ï¼Œç¡®ä¿ä¾èµ–è§£ææ­£ç¡®ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šéªŒè¯æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨æ€§ï¼ˆæå‰æ’æŸ¥è·¯å¾„é—®é¢˜ï¼‰
      - name: Verify critical files/directories
        run: |
          echo "=== Root directory files ==="
          dir
          echo "=== Check src-tauri (Tauri core) ==="
          if (Test-Path src-tauri) { echo "âœ… src-tauri exists" } else { echo "âŒ src-tauri missing"; exit 1; }
          echo "=== Check package-lock.json (npm deps) ==="
          if (Test-Path package-lock.json) { echo "âœ… package-lock.json exists" } else { echo "âŒ package-lock.json missing"; exit 1; }
          echo "=== Check src-tauri/Cargo.toml (Rust deps) ==="
          if (Test-Path src-tauri/Cargo.toml) { echo "âœ… Cargo.toml exists" } else { echo "âŒ Cargo.toml missing"; exit 1; }
        shell: pwsh

      # æ­¥éª¤3ï¼šå®‰è£…Node.jsï¼ˆåŒ¹é…é¡¹ç›®ä¾èµ–ï¼Œç¼“å­˜npmä¾èµ–ï¼‰
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"  # å…¼å®¹@tauri-apps/cli@2.8.4ï¼ˆéœ€Node>=10ï¼‰
          cache: "npm"
          cache-dependency-path: ./package-lock.json  # æ ¹ç›®å½•é”æ–‡ä»¶è·¯å¾„æ­£ç¡®

      # æ­¥éª¤4ï¼šè®¾ç½®Rustå·¥å…·é“¾ï¼ˆTauriæ„å»ºå¿…éœ€ï¼‰
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # æ­¥éª¤4.5ï¼šå®‰è£…Windowsæ„å»ºä¾èµ–ï¼ˆNSISã€WiXã€ImageMagickï¼‰
      - name: Install Windows build dependencies
        run: |
          choco install nsis -y
          choco install wixtoolset -y
          choco install imagemagick -y
        shell: pwsh

      # æ­¥éª¤4.6ï¼šç”Ÿæˆæ‰€éœ€å›¾æ ‡æ–‡ä»¶
      - name: Generate icon files
        run: |
          echo "=== Generating icon files ==="
          
          # Create a simple app icon using ImageMagick (geometric design)
          echo "ğŸ¨ Creating base icon design..."
          magick -size 128x128 canvas:transparent `
            -fill "#3B82F6" -draw "roundrectangle 16,16 112,112 16,16" `
            -fill "#FFFFFF" -pointsize 48 -gravity center `
            -annotate +0+0 "SW" "src-tauri/icons/base-icon.png"
          
          if ($LASTEXITCODE -ne 0) {
            echo "âŒ Failed to create base icon"; exit 1
          }
          
          # Generate all required sizes
          echo "ğŸ“ Generating icon sizes..."
          magick "src-tauri/icons/base-icon.png" -resize 32x32 "src-tauri/icons/32x32.png"
          magick "src-tauri/icons/base-icon.png" -resize 128x128 "src-tauri/icons/128x128.png"
          magick "src-tauri/icons/base-icon.png" -resize 256x256 "src-tauri/icons/128x128@2x.png"
          
          # Generate ICO file with multiple sizes
          echo "ğŸ”§ Creating Windows ICO file..."
          magick "src-tauri/icons/32x32.png" "src-tauri/icons/128x128.png" "src-tauri/icons/icon.ico"
          
          # Generate ICNS for macOS (if needed)
          echo "ğŸ Creating macOS ICNS file..."
          magick "src-tauri/icons/128x128.png" "src-tauri/icons/icon.icns"
          
          if ($LASTEXITCODE -eq 0) {
            echo "âœ… Successfully generated all icon files"
            echo "ğŸ“‹ Generated files:"
            ls src-tauri/icons/ | ForEach-Object { echo "  - $_" }
          } else {
            echo "âŒ Failed to generate icon files"; exit 1
          }
        shell: pwsh

      # æ­¥éª¤5ï¼šå®‰è£…å‰ç«¯ä¾èµ–ï¼ˆciæ¨¡å¼æ›´ä¸¥æ ¼ï¼Œç¡®ä¿ä¾èµ–ä¸€è‡´æ€§ï¼‰
      - name: Install frontend dependencies
        run: npm ci --no-cache
        env:
          npm_config_registry: https://registry.npmjs.org

      # æ­¥éª¤6ï¼šéªŒè¯Tauri CLIå®‰è£…å’Œé…ç½®
      - name: Verify Tauri CLI installation and config
        run: |
          echo "=== Tauri CLI Version ==="
          npx --yes @tauri-apps/cli@latest --version
          
          echo "=== Tauri Environment Info ==="
          npx --yes @tauri-apps/cli@latest info
          
          echo "=== NPM Tauri Package Versions ==="
          npm ls @tauri-apps/api @tauri-apps/plugin-fs @tauri-apps/plugin-dialog
          
          echo "=== Rust Tauri Crate Versions ==="
          Push-Location src-tauri
          cargo tree | grep -E "tauri|tauri-plugin" | head -10
          Pop-Location
          
          echo "=== Verify Config File ==="
          if (Test-Path "src-tauri/tauri.conf.json") {
            echo "âœ… Config file exists"
            echo "ğŸ“‹ Config content preview:"
            Get-Content "src-tauri/tauri.conf.json" | Select-Object -First 10
          } else { 
            echo "âŒ Config file missing"; exit 1 
          }
          
          if ($LASTEXITCODE -ne 0) { exit 1 }
        shell: pwsh

      # æ­¥éª¤7ï¼šæ„å»ºTauriåº”ç”¨ Releaseç‰ˆæœ¬
      - name: Build Tauri app (Release)
        run: npx --yes @tauri-apps/cli@latest build --config src-tauri/tauri.conf.json
        env:
          TAURI_BUILD_MODE: release
          TAURI_APP_NAME: "Serial Pilot"
          TAURI_APP_VERSION: "0.1.0"
          TAURI_APP_IDENTIFIER: "com.serialpilot.desktop"
        working-directory: ./

      # æ­¥éª¤8ï¼šé‡å‘½åReleaseæ„å»ºäº§ç‰©ä»¥åŒºåˆ†ç‰ˆæœ¬
      - name: Rename Release build artifacts
        run: |
          echo "=== Renaming Release artifacts ==="
          if (Test-Path "src-tauri/target/release/bundle/msi") {
            Get-ChildItem "src-tauri/target/release/bundle/msi/*.msi" | ForEach-Object {
              $newName = $_.Name -replace "\.msi$", "-Release.msi"
              Rename-Item $_.FullName $newName
              echo "âœ… Renamed to: $newName"
            }
          }
          if (Test-Path "src-tauri/target/release/bundle/app") {
            Get-ChildItem "src-tauri/target/release/bundle/app" -Directory | ForEach-Object {
              $newName = $_.Name + "-Release"
              Rename-Item $_.FullName $newName
              echo "âœ… Renamed app folder to: $newName"
            }
          }
        shell: pwsh

      # æ­¥éª¤9ï¼šæ„å»ºTauriåº”ç”¨ Debugç‰ˆæœ¬ï¼ˆå¸¦æ§åˆ¶å°ï¼‰
      - name: Build Tauri app (Debug with console)
        run: npx --yes @tauri-apps/cli@latest build --config src-tauri/tauri.conf.json --features console
        env:
          TAURI_BUILD_MODE: release
          TAURI_APP_NAME: "Serial Pilot Debug"
          TAURI_APP_VERSION: "0.1.0"
          TAURI_APP_IDENTIFIER: "com.serialpilot.desktop"
        working-directory: ./

      # æ­¥éª¤10ï¼šé‡å‘½åDebugæ„å»ºäº§ç‰©ä»¥åŒºåˆ†ç‰ˆæœ¬
      - name: Rename Debug build artifacts
        run: |
          echo "=== Renaming Debug artifacts ==="
          if (Test-Path "src-tauri/target/release/bundle/msi") {
            Get-ChildItem "src-tauri/target/release/bundle/msi/*.msi" | Where-Object { $_.Name -notlike "*Release*" } | ForEach-Object {
              $newName = $_.Name -replace "\.msi$", "-Debug.msi"
              Rename-Item $_.FullName $newName
              echo "âœ… Renamed to: $newName"
            }
          }
          if (Test-Path "src-tauri/target/release/bundle/app") {
            Get-ChildItem "src-tauri/target/release/bundle/app" -Directory | Where-Object { $_.Name -notlike "*Release*" } | ForEach-Object {
              $newName = $_.Name + "-Debug"
              Rename-Item $_.FullName $newName
              echo "âœ… Renamed app folder to: $newName"
            }
          }
        shell: pwsh

      # æ­¥éª¤11ï¼šä¸Šä¼ Releaseç‰ˆæœ¬æ„å»ºäº§ç‰©ï¼ˆæ— å‹ç¼©ï¼‰
      - name: Upload Release build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serial-pilot-windows-release
          path: |
            ./src-tauri/target/release/bundle/**/*Release*
            !./src-tauri/target/release/bundle/**/temp/
          retention-days: 30
          compression-level: 0

      # æ­¥éª¤12ï¼šä¸Šä¼ Debugç‰ˆæœ¬æ„å»ºäº§ç‰©ï¼ˆæ— å‹ç¼©ï¼‰
      - name: Upload Debug build artifacts  
        uses: actions/upload-artifact@v4
        with:
          name: serial-pilot-windows-debug
          path: |
            ./src-tauri/target/release/bundle/**/*Debug*
            !./src-tauri/target/release/bundle/**/temp/
          retention-days: 30
          compression-level: 0