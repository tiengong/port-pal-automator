name: Tauri Build for Windows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ï¼ˆåŒ…å«å®Œæ•´å†å²ï¼Œç¡®ä¿ä¾èµ–è§£ææ­£ç¡®ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šéªŒè¯æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨æ€§ï¼ˆæå‰æ’æŸ¥è·¯å¾„é—®é¢˜ï¼‰
      - name: Verify critical files/directories
        run: |
          echo "=== Root directory files ==="
          dir
          echo "=== Check src-tauri (Tauri core) ==="
          if (Test-Path src-tauri) { echo "âœ… src-tauri exists" } else { echo "âŒ src-tauri missing"; exit 1; }
          echo "=== Check package-lock.json (npm deps) ==="
          if (Test-Path package-lock.json) { echo "âœ… package-lock.json exists" } else { echo "âŒ package-lock.json missing"; exit 1; }
          echo "=== Check src-tauri/Cargo.toml (Rust deps) ==="
          if (Test-Path src-tauri/Cargo.toml) { echo "âœ… Cargo.toml exists" } else { echo "âŒ Cargo.toml missing"; exit 1; }
        shell: pwsh

      # æ­¥éª¤3ï¼šå®‰è£…Node.jsï¼ˆåŒ¹é…é¡¹ç›®ä¾èµ–ï¼Œç¼“å­˜npmä¾èµ–ï¼‰
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"  # å…¼å®¹@tauri-apps/cli@2.8.4ï¼ˆéœ€Node>=10ï¼‰
          cache: "npm"
          cache-dependency-path: ./package-lock.json  # æ ¹ç›®å½•é”æ–‡ä»¶è·¯å¾„æ­£ç¡®

      # æ­¥éª¤4ï¼šè®¾ç½®Rustå·¥å…·é“¾ï¼ˆTauriæ„å»ºå¿…éœ€ï¼‰
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      # æ­¥éª¤4.5ï¼šå®‰è£…Windowsæ„å»ºä¾èµ–ï¼ˆNSISã€WiXã€ImageMagickï¼‰
      - name: Install Windows build dependencies
        run: |
          choco install nsis -y
          choco install wixtoolset -y
          choco install imagemagick -y
        shell: pwsh

      # æ­¥éª¤4.6ï¼šéªŒè¯å¹¶ä¿®å¤å›¾æ ‡æ–‡ä»¶
      - name: Validate and repair icon files
        run: |
          echo "=== Icon validation and repair ==="
          
          # Check if required PNGs exist
          if (-not (Test-Path "src-tauri/icons/32x32.png")) { 
            echo "âŒ 32x32.png missing - cannot generate ICO"; exit 1 
          }
          if (-not (Test-Path "src-tauri/icons/128x128.png")) { 
            echo "âŒ 128x128.png missing - cannot generate ICO"; exit 1 
          }
          
          # Validate existing ICO or regenerate if invalid/missing
          $icoValid = $false
          if (Test-Path "src-tauri/icons/icon.ico") {
            try {
              # Check ICO signature (first 4 bytes should be: 00 00 01 00)
              $bytes = [System.IO.File]::ReadAllBytes("src-tauri/icons/icon.ico")
              if ($bytes.Length -gt 4 -and $bytes[0] -eq 0 -and $bytes[1] -eq 0 -and $bytes[2] -eq 1 -and $bytes[3] -eq 0) {
                echo "âœ… icon.ico exists and has valid signature"
                $icoValid = $true
              } else {
                echo "âš ï¸ icon.ico has invalid signature - will regenerate"
              }
            } catch {
              echo "âš ï¸ icon.ico validation failed - will regenerate"
            }
          } else {
            echo "âš ï¸ icon.ico missing - will generate"
          }
          
          # Regenerate ICO if invalid or missing
          if (-not $icoValid) {
            echo "ğŸ”§ Generating new icon.ico from PNG sources..."
            magick convert "src-tauri/icons/32x32.png" "src-tauri/icons/128x128.png" "src-tauri/icons/icon.ico"
            if ($LASTEXITCODE -eq 0) {
              echo "âœ… Successfully generated icon.ico"
            } else {
              echo "âŒ Failed to generate icon.ico"; exit 1
            }
          }
        shell: pwsh

      # æ­¥éª¤5ï¼šå®‰è£…å‰ç«¯ä¾èµ–ï¼ˆciæ¨¡å¼æ›´ä¸¥æ ¼ï¼Œç¡®ä¿ä¾èµ–ä¸€è‡´æ€§ï¼‰
      - name: Install frontend dependencies
        run: npm ci --no-cache
        env:
          npm_config_registry: https://registry.npmjs.org

      # æ­¥éª¤6ï¼šéªŒè¯Tauri CLIå®‰è£…
      - name: Verify Tauri CLI installation
        run: |
          npx tauri --version
          if ($LASTEXITCODE -ne 0) { exit 1 }
        shell: pwsh

      # æ­¥éª¤7ï¼šæ„å»ºTauriåº”ç”¨
      - name: Build Tauri app (release mode)
        run: npx tauri build
        env:
          TAURI_BUILD_MODE: release
        working-directory: ./  # ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼ˆnpxæ‰¾node_modulesï¼‰

      # æ­¥éª¤8ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆæŒ‰å¹³å°åˆ†ç±»ï¼Œä¿ç•™7å¤©ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serial-wiz-windows
          path: |
            ./src-tauri/target/release/bundle/**/*
            !./src-tauri/target/release/bundle/**/temp/
          retention-days: 7
          compression-level: 6